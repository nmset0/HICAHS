---
title: "Health Risk and Worker Density"
author: "Nathan Seto"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include = FALSE}
library(formatR)
library(knitr)
library(tidyverse)
library(stargazer)
library(ggcorrplot)
opts_chunk$set(echo = FALSE, eval = TRUE, tidy = TRUE, warning = FALSE, message = FALSE)
Risk_H2AWorkers <- read_csv("~/internship/workspace/wildfire_disaster.csv")
```

### (1) What is the relationship between health risk factors and worker densities in the HICAHS area?

#### i. calculate unconditional correlations between worker concentrations (e.g., totals) and fire and heat environmental exposure scales (identified on website as capturing aspects of “human risk”)

#### ii.similar correlations for other available indicators that may be of interest

#### iii. use county-level as the geo-observational unit
$\\$

```{r}
temp_cor_test <- cor.test(Risk_H2AWorkers$mean_temperature, Risk_H2AWorkers$total_workers, method = "spearman")
  fire_exp_cor_est <- cor.test(Risk_H2AWorkers$wildfire_exposure_total, Risk_H2AWorkers$total_workers, method = "spearman")
    fire_hazard_cor_tset <- cor.test(Risk_H2AWorkers$wildfire_hazard_type_risk_index_score, Risk_H2AWorkers$total_workers, method = "spearman")
    
plot1 <- ggplot(data = Risk_H2AWorkers, aes(y = total_workers, x = wildfire_hazard_type_risk_index_score)) +
  geom_point(aes(color = county_name)) +
  geom_smooth(method='lm', se=FALSE, col = "black", linewidth = 0.5) +
  facet_wrap(.~state, scales = "free") +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(title = "Wildfire Risk Score and Worker Totals",
       x = "Wildfire Hazard Type Risk Index Score",
       y = "Total H2A Workers")

plot2 <- ggplot(data = Risk_H2AWorkers, aes(y = total_workers, x = mean_temperature)) +
  geom_point(aes(color = county_name)) +
  geom_smooth(method='lm', se=FALSE, col = "black", linewidth = 0.5) +
  facet_wrap(.~state, scales = "free") +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(title = "Average Temperature and Worker Totals",
       x = "Mean Temperature",
       y = "Total H2A Workers")

plot1
plot2
```


```{r}
split_datasets <- split(Risk_H2AWorkers, Risk_H2AWorkers$state)

MaxTemp_WorkerTotal_lm <- lm(total_workers ~ maximum_temperature, data = Risk_H2AWorkers)

colorado <- split_datasets[[1]]
  montana <- split_datasets[[2]]
    north_dakota <- split_datasets[[3]]
      south_dakota <- split_datasets[[4]]
        utah <- split_datasets[[5]]
          wyoming <- split_datasets[[6]]

colorado_lm <- lm(maximum_temperature ~ total_workers, data = colorado)
  wyoming_lm <- lm(maximum_temperature ~ total_workers, data = wyoming)
    north_dakota_lm <- lm(maximum_temperature ~ total_workers, data = north_dakota)
      south_dakota_lm <- lm(maximum_temperature ~ total_workers, data = south_dakota)
        utah_lm <- lm(maximum_temperature ~ total_workers, data = utah)

CO_rsq <- cor(x = colorado$maximum_temperature, y = colorado$total_workers)
  MT_rsq <- cor(x = montana$maximum_temperature, y = montana$total_workers)
    ND_rsq <- cor(x = north_dakota$maximum_temperature, y = north_dakota$total_workers)
      SD_rsq <- cor(x = south_dakota$maximum_temperature, y = south_dakota$total_workers)
        WY_rsq <- cor(x = wyoming$maximum_temperature, y = wyoming$total_workers)
          UT_rsq <- cor(x = utah$maximum_temperature, y = utah$total_workers)

r_squared <- data.frame(State = c("Colorado", "Wyoming", "North Dakota", "South Dakota", "Utah"),
                          Model_R_sqr = c(
                            summary(colorado_lm)$r.squared,
                            summary(wyoming_lm)$r.squared,
                            summary(north_dakota_lm)$r.squared,
                            summary(south_dakota_lm)$r.squared,
                            summary(utah_lm)$r.squared), 
                        Pearson_Corr = c(CO_rsq, WY_rsq, ND_rsq, SD_rsq, UT_rsq))

kable(r_squared, col.names = c("State", "Multiple R-Sqr", "Pearson Corr. Coef."), align = 'lcc', label = "Correlation Between Heat and Worker Density", digits = 3)

FireHzrdIdxScore_WorkerTotal_lm <- lm(total_workers ~ `wildfire_hazard_type_risk_index_score`, data = Risk_H2AWorkers)
FireExpTotal_WorkerTotal_lm <- lm(total_workers ~ `wildfire_exposure_total`, data = Risk_H2AWorkers)

cat("Linear Model of Maximum Temperature and Worker Totals: \n")
stargazer(FireExpTotal_WorkerTotal_lm, type = "text", title = "Summary Statistics", out = "summary_statistics.txt")
cat("\nLinear Model of Wild Fire Hazard Index Score and Worker Totals: \n")
stargazer(FireHzrdIdxScore_WorkerTotal_lm, type = "text", title = "Summary Statistics of Coefficients", out = "summary_coefficients.txt")
cat("\nLinear Model of Fire Exposure Total and Worker Totals: \n")
stargazer(FireExpTotal_WorkerTotal_lm, type = "text", title = "Summary Statistics of Coefficients", out = "summary_coefficients.txt")
```

```{r}
correlation_vector <- c()
  Risk_H2AWorkers_num <- Risk_H2AWorkers[, sapply(Risk_H2AWorkers, is.numeric)]
    N <- colnames(Risk_H2AWorkers_num)
      for (i in N) {
        correlation_value <- cor(x = Risk_H2AWorkers_num[[i]], y = Risk_H2AWorkers_num$total_workers, method = "spearman")
        correlation_vector <- c(correlation_vector, correlation_value)
      }
        correlation_df <- data.frame(column = N, correlation = correlation_vector) |> arrange(desc(correlation))
          correlation_df <-  correlation_df[-1, ]

# Correlogram ggcorrplot()
temp <- Risk_H2AWorkers[sapply(Risk_H2AWorkers, is.numeric)]
corr <- round(cor(temp, method = "spearman"),2)
matrix <- cor_pmat(temp)
corrplot <- ggcorrplot(corr, p.mat = matrix, type = "full",
    lab = TRUE, lab_size = 1.6, insig = "blank", title = "Correlation Plot") +
    theme(axis.text.x = element_text(size = 4.1, angle = 90, hjust = 1),
    axis.text.y = element_text(size = 4.1)
)

cat("\n\n Correlation of all Variables with Total Workers \n")
print(tibble(correlation_df), n = nrow(correlation_df))
cat("\n\n")
corrplot
```


```{r appendix, echo = TRUE, eval = FALSE, message = FALSE, warning = FALSE}
library(formatR)
library(knitr)
library(tidyverse)
library(stargazer)
library(ggcorrplot)
opts_chunk$set(echo = FALSE, eval = TRUE, tidy = TRUE, warning = FALSE, message = FALSE)
Risk_H2AWorkers <- read_csv("~/internship/workspace/wildfire_disaster.csv")

# initial correlation tests
temp_cor_test <- cor.test(Risk_H2AWorkers$mean_temperature, Risk_H2AWorkers$total_workers, method = "spearman")
  fire_exp_cor_est <- cor.test(Risk_H2AWorkers$wildfire_exposure_total, Risk_H2AWorkers$total_workers, method = "spearman")
    fire_hazard_cor_tset <- cor.test(Risk_H2AWorkers$wildfire_hazard_type_risk_index_score, Risk_H2AWorkers$total_workers, method = "spearman")
    
# seeing what the data looks like
plot1 <- ggplot(data = Risk_H2AWorkers, aes(y = total_workers, x = wildfire_hazard_type_risk_index_score)) +
  geom_point(aes(color = county_name)) +
  geom_smooth(method='lm', se=FALSE, col = "black", linewidth = 0.5) +
  facet_wrap(.~state, scales = "free") +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(title = "Wildfire Risk Score and Worker Totals",
       x = "Wildfire Hazard Type Risk Index Score",
       y = "Total H2A Workers")

plot2 <- ggplot(data = Risk_H2AWorkers, aes(y = total_workers, x = mean_temperature)) +
  geom_point(aes(color = county_name)) +
  geom_smooth(method='lm', se=FALSE, col = "black", linewidth = 0.5) +
  facet_wrap(.~state, scales = "free") +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(title = "Average Temperature and Worker Totals",
       x = "Mean Temperature",
       y = "Total H2A Workers")

plot1
plot2

split_datasets <- split(Risk_H2AWorkers, Risk_H2AWorkers$state)

MaxTemp_WorkerTotal_lm <- lm(total_workers ~ maximum_temperature, data = Risk_H2AWorkers)

colorado <- split_datasets[[1]]
  montana <- split_datasets[[2]]
    north_dakota <- split_datasets[[3]]
      south_dakota <- split_datasets[[4]]
        utah <- split_datasets[[5]]
          wyoming <- split_datasets[[6]]
          
# maximum temperature correlated with worker totals
colorado_lm <- lm(maximum_temperature ~ total_workers, data = colorado)
  wyoming_lm <- lm(maximum_temperature ~ total_workers, data = wyoming)
    north_dakota_lm <- lm(maximum_temperature ~ total_workers, data = north_dakota)
      south_dakota_lm <- lm(maximum_temperature ~ total_workers, data = south_dakota)
        utah_lm <- lm(maximum_temperature ~ total_workers, data = utah)

CO_rsq <- cor(x = colorado$maximum_temperature, y = colorado$total_workers)
  MT_rsq <- cor(x = montana$maximum_temperature, y = montana$total_workers)
    ND_rsq <- cor(x = north_dakota$maximum_temperature, y = north_dakota$total_workers)
      SD_rsq <- cor(x = south_dakota$maximum_temperature, y = south_dakota$total_workers)
        WY_rsq <- cor(x = wyoming$maximum_temperature, y = wyoming$total_workers)
          UT_rsq <- cor(x = utah$maximum_temperature, y = utah$total_workers)

r_squared <- data.frame(State = c("Colorado", "Wyoming", "North Dakota", "South Dakota", "Utah"),
                          Model_R_sqr = c(
                            summary(colorado_lm)$r.squared,
                            summary(wyoming_lm)$r.squared,
                            summary(north_dakota_lm)$r.squared,
                            summary(south_dakota_lm)$r.squared,
                            summary(utah_lm)$r.squared), 
                        Pearson_Corr = c(CO_rsq, WY_rsq, ND_rsq, SD_rsq, UT_rsq))

kable(r_squared, col.names = c("State", "Multiple R-Sqr", "Pearson Corr. Coef."), align = 'lcc', label = "Correlation Between Heat and Worker Density", digits = 3)

FireHzrdIdxScore_WorkerTotal_lm <- lm(total_workers ~ `wildfire_hazard_type_risk_index_score`, data = Risk_H2AWorkers)
FireExpTotal_WorkerTotal_lm <- lm(total_workers ~ `wildfire_exposure_total`, data = Risk_H2AWorkers)

cat("Linear Model of Maximum Temperature and Worker Totals: \n")
stargazer(FireExpTotal_WorkerTotal_lm, type = "text", title = "Summary Statistics", out = "summary_statistics.txt")
cat("\nLinear Model of Wild Fire Hazard Index Score and Worker Totals: \n")
stargazer(FireHzrdIdxScore_WorkerTotal_lm, type = "text", title = "Summary Statistics of Coefficients", out = "summary_coefficients.txt")
cat("\nLinear Model of Fire Exposure Total and Worker Totals: \n")
stargazer(FireExpTotal_WorkerTotal_lm, type = "text", title = "Summary Statistics of Coefficients", out = "summary_coefficients.txt")

# calculating all correlations with total workers
correlation_vector <- c()
  Risk_H2AWorkers_num <- Risk_H2AWorkers[, sapply(Risk_H2AWorkers, is.numeric)]
    N <- colnames(Risk_H2AWorkers_num)
      for (i in N) {
        correlation_value <- cor(x = Risk_H2AWorkers_num[[i]], y = Risk_H2AWorkers_num$total_workers, method = "spearman")
        correlation_vector <- c(correlation_vector, correlation_value)
      }
        correlation_df <- data.frame(column = N, correlation = correlation_vector) |> arrange(desc(correlation))
          correlation_df <-  correlation_df[-1, ]

# Correlogram
temp <- Risk_H2AWorkers[sapply(Risk_H2AWorkers, is.numeric)]
corr <- round(cor(temp, method = "spearman"),2)
matrix <- cor_pmat(temp)
corrplot <- ggcorrplot(corr, p.mat = matrix, type = "full",
    lab = TRUE, lab_size = 1.6, insig = "blank", title = "Correlation Plot") +
    theme(axis.text.x = element_text(size = 4.1, angle = 90, hjust = 1),
    axis.text.y = element_text(size = 4.1)
)

cat("\n\n Correlation of all Variables with Total Workers \n")
print(tibble(correlation_df), n = nrow(correlation_df))
cat("\n\n")
corrplot
```

