---
title: "Economic Output and Risk Factors"
author: "Nathan Seto"
output: pdf_document
---

```{r, include = FALSE}
rm(list=ls())
library(knitr)
library(tidyr)
library(tidyverse)
library(readr)
library(ggcorrplot)
library(dplyr)
opts_chunk$set(echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE, tidy = TRUE)
```

## What is the relationship between health risk concentrations and economic output?

#### Calculate correlations between environmental exposures and farm sales (and/or other econ. variables) to understand economic linkages.

A p-value of 0 reflects that it is statistically impossible to reach these results under a true null hypothesis.

```{r, include = FALSE}
output_risk_combined <- read_csv("~/internship/workspace/Analysis/output_risk_combined.csv")
# source("C:/Users/natha/OneDrive/Documents/internship/workspace/Analysis/outputriskfunction.R")
# process_risk_data(output_risk_combined, "crop_totals_sales_measured_in_$")
# correlation_df <- correlation_df[-1,]
# correlation_df$p_value <- round(correlation_df$p_value, digits = 4)
# split_dfs <- split(correlation_df, correlation_df$category)
# list2env(split(correlation_df, correlation_df$category), envir = .GlobalEnv)
```


Below are a series of correlation plots between variables of economic output and different weather and natural disaster predictors.
$\\$

```{r}
output_risk_combined <- output_risk_combined |> mutate(across(everything(), ~ gsub(",", "", .)))

cols <- names(output_risk_combined)[grepl("income|sales|farm_sales|income_net|commodity_totals|crop_totals_sales", 
                                                   names(output_risk_combined), ignore.case = TRUE)]

output_risk_combined <- output_risk_combined |> mutate(across(all_of(cols), as.numeric))

output_risk_combined <- output_risk_combined |>
  mutate(across(where(is.character), ~{
    if(any(grepl("\\d+", .x))) {
      cleaned <- gsub("[^0-9.-]", "", .x)
      as.numeric(cleaned)
    } else {
      .x
    }
  }))

output_environmentalRisk <- output_risk_combined  |>
  select(matches("farm_sales_|drought|wildfire|Cold\\.Wave|tornado|ice\\.storm|winter\\.weather|strong\\.wind|hail|heat\\.wave|avalanche|Landslide|lightning|income")) |> select(where(is.numeric))

output_environmentalRisk[is.na(output_environmentalRisk)] <- 0

subset_df <- output_environmentalRisk[, grep("income|sales|farm_sales|income_net|commodity_totals|crop_totals_sales", names(output_environmentalRisk), ignore.case = TRUE), drop = FALSE]


risk_types <- c("drought", "wildfire", "Cold\\.Wave", "tornado",
                "ice\\.storm", "winter\\.weather", "strong\\.wind", "hail",
                "heat\\.wave", "avalanche", "Landslide", "lightning")

risk_dfs <- list()

for (risk in risk_types) {
  clean_risk_name <- gsub("\\\\", "", risk)

  risk_dfs[[clean_risk_name]] <- output_environmentalRisk[, grepl(risk, names(output_environmentalRisk), ignore.case = TRUE)] |> cbind(subset_df)
}

for (i in names(risk_dfs)) {
  assign(i, risk_dfs[[i]])
}

source("C:/Users/natha/OneDrive/Documents/internship/workspace/Analysis/create_correlogram_function.R")

N <- c("drought", "wildfire", "Cold.Wave", "tornado", "ice.storm", "winter.weather", "strong.wind", "hail", "heat.wave", "avalanche", "Landslide", "lightning")
generate_corr_plot(N)

print(drought_corrplot)
print(heat.wave_corrplot)
print(wildfire_corrplot)
print(winter.weather_corrplot)
print(Cold.Wave_corrplot)
print(hail_corrplot)
print(ice.storm_corrplot)
print(strong.wind_corrplot)
print(tornado_corrplot)
print(lightning_corrplot)
print(avalanche_corrplot)
```

